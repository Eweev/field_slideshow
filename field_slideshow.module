<?php

/**
 * @file
 * Implement a slideshow formatter for fields.
 */

/**
 * Implements hook_field_formatter_info().
 */
function field_slideshow_field_formatter_info() {
  $formatters = array(
    'slideshow' => array(
      'label'       => t('Slideshow'),
      'field types' => array('image', 'media'),
      'settings'    => array(
        'slideshow_image_style'       => '',
        'slideshow_link'              => '',
        'slideshow_caption'           => '',
        'slideshow_caption_link'      => '',
        'slideshow_fx'                => 'fade',
        'slideshow_speed'             => '1000',
        'slideshow_timeout'           => '4000',
        'slideshow_pager'             => '',
        'slideshow_pager_image_style' => '',
        'slideshow_controls'          => '',
        'slideshow_pause'             => '',
      ),
    ),
  );
  if (module_exists('colorbox')) $formatters['slideshow']['settings']['slideshow_colorbox_image_style'] = '';

  return $formatters;
}

/**
 * Implements hook_field_formatter_settings_form().
 */
function field_slideshow_field_formatter_settings_form($field, $instance, $view_mode, $form, &$form_state) {
  $display = $instance['display'][$view_mode];
  $settings = $display['settings'];

  $element['slideshow_image_style'] = array(
    '#title'          => t('Image style'),
    '#type'           => 'select',
    '#default_value'  => $settings['slideshow_image_style'],
    '#empty_option'   => t('None (original image)'),
    '#options'        => image_style_options(FALSE),
  );

  $element['slideshow_link'] = array(
    '#title'          => t('Link image to'),
    '#type'           => 'select',
    '#default_value'  => $settings['slideshow_link'],
    '#empty_option'   => t('Nothing'),
    '#options'        => array(
      'content' => t('Content'),
      'file'    => t('File'),
    ),
  );
  if (module_exists('colorbox')) {
    $element['slideshow_link']['#options']['colorbox'] = 'Colorbox';
    $element['slideshow_colorbox_image_style'] = array(
      '#title'          => t('Colorbox image style'),
      '#type'           => 'select',
      '#default_value'  => $settings['slideshow_colorbox_image_style'],
      '#empty_option'   => t('None (original image)'),
      '#options'        => image_style_options(FALSE),
      '#states' => array(
        'visible' => array(
          ':input[name$="[settings_edit_form][settings][slideshow_link]"]' => array('value' => 'colorbox'),
        ),
      ),
    );
  }

  $element['slideshow_caption'] = array(
    '#title'          => t('Caption'),
    '#type'           => 'select',
    '#default_value'  => $settings['slideshow_caption'],
    '#empty_option'   => t('Nothing'),
    '#options'        => array(
      'title'   => t('Title text'),
      'alt'     => t('Alt text'),
    ),
  );

  $element['slideshow_caption_link'] = array(
    '#title'          => t('Caption link'),
    '#type'           => 'select',
    '#default_value'  => $settings['slideshow_caption_link'],
    '#empty_option'   => t('Nothing'),
    '#options'        => array(
      'content' => t('Content'),
      'file'    => t('File'),
    ),
    '#states' => array(
      'invisible' => array(
        ':input[name$="[settings_edit_form][settings][slideshow_caption]"]' => array('value' => ''),
      ),
    ),
  );
  if (module_exists('colorbox')) $element['slideshow_caption_link']['#options']['colorbox'] = 'Colorbox';

  $element['slideshow_fx'] = array(
    '#title'          => t('Transition effect'),
    '#type'           => 'select',
    '#default_value'  => $settings['slideshow_fx'],
    '#options'        => array(
      'blindX'      => t('blindX'),
      'blindY'      => t('blindY'),
      'blindZ'      => t('blindZ'),
      'cover'       => t('cover'),
      'curtainX'    => t('curtainX'),
      'curtainY'    => t('curtainY'),
      'fade'        => t('fade'),
      'fadeZoom'    => t('fadeZoom'),
      'growX'       => t('growX'),
      'growY'       => t('growY'),
      'scrollUp'    => t('scrollUp'),
      'scrollDown'  => t('scrollDown'),
      'scrollLeft'  => t('scrollLeft'),
      'scrollRight' => t('scrollRight'),
      'scrollHorz'  => t('scrollHorz'),
      'scrollVert'  => t('scrollVert'),
      'shuffle'     => t('shuffle'),
      'slideX'      => t('slideX'),
      'slideY'      => t('slideY'),
      'toss'        => t('toss'),
      'turnUp'      => t('turnUp'),
      'turnDown'    => t('turnDown'),
      'turnLeft'    => t('turnLeft'),
      'turnRight'   => t('turnRight'),
      'uncover'     => t('uncover'),
      'wipe'        => t('wipe'),
      'zoom'        => t('zoom'),
    ),
  );

  $element['slideshow_speed'] = array(
    '#title'          => t('Transition speed'),
    '#type'           => 'textfield',
    '#size'           => 5,
    '#default_value'  => $settings['slideshow_speed'],
  );

  $element['slideshow_timeout'] = array(
    '#title'          => t('Timeout'),
    '#type'           => 'textfield',
    '#size'           => 5,
    '#default_value'  => $settings['slideshow_timeout'],
    '#description'    => t('Time between transitions (ms). Enter 0 to disable automatic transitions (then, enable pager and/or controls).'),
  );

  $element['slideshow_pager'] = array(
    '#title'          => t('Pager'),
    '#type'           => 'select',
    '#options'        => array('number' => 'Slide number', 'image' => 'Image'),
    '#empty_option'   => t('None'),
    '#default_value'  => $settings['slideshow_pager'],
  );

  $element['slideshow_pager_image_style'] = array(
    '#title'          => t('Pager image style'),
    '#type'           => 'select',
    '#default_value'  => $settings['slideshow_pager_image_style'],
    '#empty_option'   => t('None (original image)'),
    '#options'        => image_style_options(FALSE),
    '#states' => array(
      'visible' => array(
        ':input[name$="[settings_edit_form][settings][slideshow_pager]"]' => array('value' => 'image'),
      ),
    ),
  );

  $element['slideshow_controls'] = array(
    '#title'          => t('Create prev/next controls'),
    '#type'           => 'checkbox',
    '#default_value'  => $settings['slideshow_controls'],
  );

  $element['slideshow_pause'] = array(
    '#title'          => t('Pause on hover'),
    '#type'           => 'checkbox',
    '#default_value'  => $settings['slideshow_pause'],
  );

  return $element;
}

/**
 * Implements hook_field_formatter_settings_summary().
 */
function field_slideshow_field_formatter_settings_summary($field, $instance, $view_mode) {
  $display = $instance['display'][$view_mode];
  $settings = $display['settings'];

  $summary = array();

  $image_styles = image_style_options(FALSE);
  // Unset possible 'No defined styles' option.
  unset($image_styles['']);
  // Styles could be lost because of enabled/disabled modules that defines
  // their styles in code.
  if (isset($image_styles[$settings['slideshow_image_style']])) {
    $summary[] = t('Image style: @style', array('@style' => $image_styles[$settings['slideshow_image_style']]));
  }
  else $summary[] = t('Original image');

  $link_types = array(
    'content'   => t('Linked to content'),
    'file'      => t('Linked to file'),
    'colorbox'  => t('Linked to Colorbox'),
  );
  // Display this setting only if image is linked.
  if (isset($link_types[$settings['slideshow_link']])) {
    $link_type_message = $link_types[$settings['slideshow_link']];
    if ($settings['slideshow_link'] == 'colorbox') {
      $link_type_message .= ' (';
      if (isset($image_styles[$settings['slideshow_colorbox_image_style']])) {
        $link_type_message .= t('Image style: @style', array('@style' => $image_styles[$settings['slideshow_colorbox_image_style']]));
      }
      else $link_type_message .=  t('Original image');
      $link_type_message .= ')';
    }
    $summary[] = $link_type_message;
  }

  $caption_types = array(
    'title' => t('Title text'),
    'alt'   => t('Alt text'),
  );
  // Display this setting only if there's a caption.
  if (isset($caption_types[$settings['slideshow_caption']])) {
    $caption_message = t('Caption : @caption', array('@caption' => $caption_types[$settings['slideshow_caption']]));
    if (isset($link_types[$settings['slideshow_caption_link']])) $caption_message .= ' (' . $link_types[$settings['slideshow_caption_link']] . ')';
    $summary[] = $caption_message;
  }

  $summary[] = t('Transition effect: @effect', array('@effect' => $settings['slideshow_fx']));
  $summary[] = t('Speed: @speed', array('@speed' => $settings['slideshow_speed']));
  $summary[] = t('Timeout: @timeout', array('@timeout' => $settings['slideshow_timeout']));

  switch ($settings['slideshow_pager']) {
    case 'number':
      $summary[] = t('Pager') . ': ' . t('Slide number');
    break;
    case 'image':
      $pager_image_message = t('Pager') . ': ' . t('Image') . ' (';
      if (isset($image_styles[$settings['slideshow_pager_image_style']])) {
        $pager_image_message .= t('Image style: @style', array('@style' => $image_styles[$settings['slideshow_pager_image_style']]));
      }
      else $pager_image_message .= t('Original image');
      $pager_image_message .= ')';
      $summary[] = $pager_image_message;
    break;
  }

  if (isset($settings['slideshow_controls']) && $settings['slideshow_controls']) $summary[] = t('Create prev/next controls');
  if (isset($settings['slideshow_pause']) && $settings['slideshow_pause']) $summary[] = t('Pause on hover');

  return implode('<br />', $summary);
}

/**
 * Implements hook_field_formatter_view().
 */
function field_slideshow_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
  $element = array();
  $links = array(
    'slideshow_link'          => 'path',
    'slideshow_caption_link'  => 'caption_path',
  );
  // Loop thru required links (because image and caption can have different links)
  foreach ($links as $setting => $path) {

    // Check if the formatter involves a link.
    if ($display['settings'][$setting] == 'content') {
      $uri = entity_uri($entity_type, $entity);
    }
    elseif ($display['settings'][$setting] == 'file' || $display['settings'][$setting] == 'colorbox') {
      $link_file = TRUE;
    }

    foreach ($items as $delta => $item) {
      $items[$delta] = (array) $item; // Media field support

      if (isset($link_file)) {
        $uri = array(
          'path'    => file_create_url($item['uri']),
          'options' => array(),
        );
        if ($display['settings'][$setting] == 'colorbox') {
          // check if we need a thumbnaill and change the link
          if ($display['settings']['slideshow_colorbox_image_style'] != '') {
            $uri['path'] = image_style_url($display['settings']['slideshow_colorbox_image_style'], $item['uri']);
          }
          $uri['options']['attributes'] = array(
            'class' => array('colorbox'),
            'rel'   => 'field-slideshow',
          );
          if ($display['settings']['slideshow_caption'] != '') $uri['options']['attributes']['title'] = $item[$display['settings']['slideshow_caption']];
        }
      }
      $items[$delta][$path] = isset($uri) ? $uri : '';
    }
    unset($uri, $link_file); // unset for next loop;

  }

  $element[] = array(
    '#theme'              => 'field_slideshow',
    '#items'              => $items,
    '#image_style'        => $display['settings']['slideshow_image_style'],
    '#caption'            => $display['settings']['slideshow_caption'],
    '#fx'                 => $display['settings']['slideshow_fx'],
    '#speed'              => $display['settings']['slideshow_speed'],
    '#timeout'            => $display['settings']['slideshow_timeout'],
    '#pager'              => $display['settings']['slideshow_pager'],
    '#pager_image_style'  => $display['settings']['slideshow_pager_image_style'],
    '#controls'           => $display['settings']['slideshow_controls'],
    '#pause'              => $display['settings']['slideshow_pause'],
  );

  return $element;
}

/**
 * Implements hook_theme().
 */
function field_slideshow_theme() {
  return array(
    'field_slideshow' => array(
      'variables'     => array(
        'items'             => NULL,
        'image_style'       => NULL,
        'caption'           => NULL,
        'speed'             => NULL,
        'fx'                => NULL,
        'timeout'           => NULL,
        'pager'             => NULL,
        'pager_image_style' => NULL,
        'controls'          => NULL,
        'pause'             => NULL,
      ),
    ),
  );
}

/**
 * Returns HTML for a slideshow formatter.
 *
 * @param $variables
 *   An associative array containing:
 *   - items: An array of images fields.
 *   - image_style: An optional image style.
 *
 * @ingroup themeable
 */
function theme_field_slideshow($variables) {
  // Generate slides
  $field_slideshow_zebra = 'odd';
  $slides_max_width = 0;
  $slides_max_height = 0;
  $slides_output = '';
  foreach ($variables['items'] as $num => $item) {
    $classes = array('field-slideshow-slide');
    $field_slideshow_zebra = ($field_slideshow_zebra == 'odd') ? 'even' : 'odd';
    $classes[] = $field_slideshow_zebra;
    if ($num == 0) $classes[] = 'first';
    elseif ($num == count($variables['items']) - 1) $classes[] = 'last';
    $slides_output .= '<div class="' . implode(' ', $classes) . '"' . ($num != 0 ? ' style="display:none;"' : '') . '>';

    // Generate the image html
    $image = array(
      'path' => $item['uri'],
      'alt' => $item['alt'],
    );
    if (drupal_strlen($item['title']) > 0) {
      $image['title'] = $item['title'];
    }
    if ($variables['image_style']) {
      $image['style_name'] = $variables['image_style'];
      $image_output = theme('image_style', $image);
    }
    else {
      $image_output = theme('image', $image);
    }

    // Get image sizes and add them the img tag, so height is correctly calctulated by Cycle
    if ($variables['image_style']) {
      $image_path = image_style_path($variables['image_style'], $image['path']);
      // if thumbnail is not generated, do it, so we can get the dimensions
      if (!file_exists($image_path)) {
        image_style_create_derivative(image_style_load($variables['image_style']), $image['path'], $image_path);
      }
    }
    else $image_path = $image['path'];
    $image_dims = getimagesize($image_path);
    $image_output = drupal_substr($image_output, 0, -2) . $image_dims[3] . ' />';
    if ($image_dims[0] > $slides_max_width) $slides_max_width = $image_dims[0];
    if ($image_dims[1] > $slides_max_height) $slides_max_height = $image_dims[1];

    // Generate the caption
    if ($variables['caption']) {
      $caption_output = '<div class="field-slideshow-caption">' . $item[$variables['caption']] . '</div>';
    }
    else $caption_output = '';

    // Add links if needed
    $links = array('path' => 'image_output');
    if ($variables['caption']) $links['caption_path'] = 'caption_output';
    // Loop thru required links (because image and caption can have different links)
    foreach ($links as $link => $out) {
      if ($item[$link]) {
        $path = $item[$link]['path'];
        $options = $item[$link]['options'];
        // When displaying an image inside a link, the html option must be TRUE.
        $options['html'] = TRUE;
        // Generate differnet rel attribute for image and caption, so colorbox doesn't double the image list
        if (isset($options['attributes']['rel'])) $options['attributes']['rel'] .= $out;
        $$out = l($$out, $path, $options);
      }
    }

    $slides_output .= $image_output . $caption_output;
    $slides_output .= '</div>'; // .fied-slideshow-slide div closed
  }

  // Generate classes
  static $field_slideshow_id = -1;
  $field_slideshow_id++;
  $classes = array('field-slideshow', 'field-slideshow-' . $field_slideshow_id, 'effect-' . $variables['fx'], 'timeout-' . $variables['timeout']);
  if ($variables['caption'] != '') $classes[] = 'caption-' . $variables['caption'];
  if ($variables['pager'] != '') $classes[] = 'with-pager';
  if ($variables['controls']) $classes[] = 'with-controls';
  $output = '<div id="field-slideshow-' . $field_slideshow_id . '-wrapper" class="field-slideshow-wrapper">
    <div class="' . implode(' ', $classes) . '" style="width:' . $slides_max_width . 'px; height:' . $slides_max_height . 'px">';

  $output .= $slides_output; // adds the slides
  $output .= '</div>'; // .field-slideshow & .field-slideshow-wrapper div closed

  // Add controls if needed
  if ($variables['controls']) {
    $output .= '<div id="field-slideshow-' . $field_slideshow_id . '-controls" class="field-slideshow-controls"><a href="#" class="prev">' . t('Prev') . '</a> <a href="#" class="next">' . t('Next') . '</a></div>';
  }

  // Add thumbnails if needed
  if ($variables['pager'] != '') {
    $output .= '<' . ($variables['pager'] == 'image' ? 'ul' : 'div') . ' id="field-slideshow-' . $field_slideshow_id . '-pager" class="field-slideshow-pager">';
    if ($variables['pager'] == 'image') {
      foreach ($variables['items'] as $num => $item) {
        $image = array(
          'path' => $item['uri'],
          'alt' => $item['alt'],
        );
        if (drupal_strlen($item['title']) > 0) {
          $image['title'] = $item['title'];
        }
        if ($variables['pager_image_style']) {
          $image['style_name'] = $variables['pager_image_style'];
          $image_output = theme('image_style', $image);
        }
        else {
          $image_output = theme('image', $image);
        }
        $output .= '<li><a href="#">' . theme('image_style', $image) . '</a></li>';
      }
    }
    $output .= '</' . ($variables['pager'] == 'image' ? 'ul' : 'div') . '>';
  }

  $output .= '</div>'; // .field-slideshow-wrapper div closed

  // Add the Cycle plugin and the Js code
  drupal_add_js(drupal_get_path('module', 'field_slideshow') . '/js/jquery.cycle.all.min.js');
  drupal_add_js(drupal_get_path('module', 'field_slideshow') . '/js/field_slideshow.js');

  // Add js variables
  unset($variables['items']);
  drupal_add_js(array('field_slideshow' => array('field-slideshow-' . $field_slideshow_id => $variables)), 'setting');

  // Add css
  drupal_add_css(drupal_get_path('module', 'field_slideshow') . '/field_slideshow.css');

  return $output;
}